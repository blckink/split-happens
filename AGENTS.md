# Agent Instructions

- Only run automated tests or checks when implementing large or complex changes. Small tweaks spanning just a few lines do not require executing the test suite.
- Comment each newly introduced code block to document its purpose clearly.
- Preserve existing functionality: double-check for syntax errors or regressions before finalizing changes.
- For UI changes, ensure a modern, well-aligned, and consistent presentation without unnecessary spacing around elements.
- Keep the build tooling resilient by re-executing `build.sh` inside `steam-run` when no system linker is present instead of prompting users to install compilers manually.
- When both `cc` and compiler shims are unavailable, rely on the bundled `rust-lld` fallback so builds continue to work on minimal SteamOS environments.
- Capture host linker search paths (including libgcc) before the `steam-run` re-exec so the rust-lld fallback can still locate them when the runtime hides the system ld cache.
- When capturing host linker assets, mirror `libgcc_s.so.1` into `target/rust-lld-shims` so sandboxed builds do not rely on host-only paths.
- When driving `rust-lld` fallbacks, harvest library search paths with `ldconfig` so glibc and friends remain discoverable, and avoid passing `-Wl,`-prefixed linker flags that the standalone linker rejects.
- Default Nemirtingas configuration log levels to error severity; only surface critical emulator issues in per-player logs.
- Before each launch, completely purge Nemirtingas `appdata` artifacts (except logs) so stale EOS command caches never trigger `COMMAND_STATE_SUBMITTED` assertion dialogs for players.
- When scrubbing Nemirtingas caches, wipe both the profile `nepice_settings/appdata` tree and the Proton prefix `AppData` directories (Roaming/Local/LocalLow) while preserving logs so the COMMAND_STATE_SUBMITTED assertion never returns.
- Persist launch warnings to a text log under the PARTY directory in addition to printing them to the console for easier debugging.
- Generate and persist unique Nemirtingas `EpicId`/`ProductUserId` pairs for each profile so invite codes stay stable between sessions.
- Treat Nemirtingas configs that still use the default `DefaultName` username as invalid placeholders; rewrite them to the Split Happens profile name so the regenerated IDs remain deterministic.
- Share a single deterministic Nemirtingas LAN port across all profiles for a game, reusing the Goldberg override when present.
- When a handler ships a Nemirtingas config (`eos.config_path`), still normalize Goldberg `listen_port` deterministically while mirroring that value into the Nemirtingas override so both systems align.
- Default Goldberg `gc_token`/`new_app_ticket` toggles to `1` (files and INI flags) so the experimental steam_api build bundled in `res/goldberg` works without manual edits.
- Keep Goldberg's `auto_accept_invite.txt` empty when enabling auto-accept so the experimental overlay bypass matches upstream documentation; avoid writing sentinel values like `1`.
- Guest profiles must use deterministic slot names (Guest1, Guest2, etc.) so saves persist between sessions instead of rotating through random aliases.
- Avoid reintroducing Nemirtingas log-mirroring debug helpers; rely on the emulator's own error-level output for diagnostics.
- `cargo check` currently fails with a borrow checker error in `src/input.rs` (E0499). Documented until the underlying issue is fixed.
- Capture any newly provided project-wide user instructions in this file so they are not forgotten on future tasks.
- When a user flags a mistake, immediately record the corrective lesson and any new global guidance here so the issue does not repeat.
- When a task exposes a recurring mistake or introduces a new global rule from the user, document it here immediately so future work remains aligned.
- Always confirm `./build.sh` completes successfully before finishing work so regressions in buildability never slip through again.
- When fixing any mistake, record the lesson here alongside new user-wide instructions so regressions and misunderstandings do not return.
- Audit complete emulator logs before summarizing state transitions (e.g., JOINABLE flips) so transient values are not misreported.
- Favor pure-Rust or system-provided tooling for HTTP/download tasks; avoid adding crates that require native C toolchains (e.g., OpenSSL, ring, zstd-sys) so Steam Deck builds stay dependency-free.
- Maintain state-of-the-art UI polish with smooth transitions, clean reusable code, perfectly aligned layouts, and avoid oversized padding or empty frames around iconography.
- Ensure controller navigation stays consistent: Circle/O/B should always return to the main menu, Cross/A confirms selections, and both the D-pad and analog sticks must move focus cleanly between adjacent UI elements.
- When painting focus outlines with egui 0.31+, always pass an explicit `StrokeKind` to `rect_stroke` so builds keep compiling after upstream API changes.
- When adding or updating KWin scripting handlers, always accept the signal's window parameter to avoid signature mismatch errors on newer Plasma releases.
- When KWin DBus calls reject numeric script identifiers with a signature mismatch, retry with the "splitscreen" script name so launches remain compatible with newer Plasma builds.
